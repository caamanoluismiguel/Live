<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ObjectStory â€” Live Discovery</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1612">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-parchment: #f7f3eb;
            --color-aged-paper: #ebe5d8;
            --color-ink: #1a1612;
            --color-sepia: #8b7355;
            --color-gold: #c9a227;
            --color-rust: #a65d3f;
            --color-sage: #6b7c5e;
            --color-deep-blue: #2c3e50;
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'DM Sans', system-ui, sans-serif;
            --ease-elegant: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-ink);
            color: var(--color-parchment);
            line-height: 1.6;
        }

        /* App Container */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Camera View - LIVE FEED */
        .camera-container {
            position: fixed;
            inset: 0;
            overflow: hidden;
            background: #0a0908;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: 
                radial-gradient(ellipse at center, transparent 40%, rgba(26,22,18,0.4) 100%);
        }

        /* Live indicator */
        .live-indicator {
            position: absolute;
            top: 70px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--color-parchment);
            opacity: 0.8;
            z-index: 15;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #e53935;
            border-radius: 50%;
            animation: livePulse 1.5s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Viewfinder */
        .viewfinder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75%;
            max-width: 320px;
            aspect-ratio: 1;
            border: 1px solid rgba(201, 162, 39, 0.25);
            border-radius: 12px;
            transition: all 0.5s var(--ease-elegant);
            pointer-events: none;
        }

        .viewfinder::before,
        .viewfinder::after {
            content: '';
            position: absolute;
            width: 28px;
            height: 28px;
            border-color: var(--color-gold);
            border-style: solid;
            transition: all 0.3s var(--ease-elegant);
        }

        .viewfinder::before {
            top: -1px;
            left: -1px;
            border-width: 3px 0 0 3px;
            border-radius: 12px 0 0 0;
        }

        .viewfinder::after {
            bottom: -1px;
            right: -1px;
            border-width: 0 3px 3px 0;
            border-radius: 0 0 12px 0;
        }

        /* Additional corners */
        .viewfinder-corner {
            position: absolute;
            width: 28px;
            height: 28px;
            border-color: var(--color-gold);
            border-style: solid;
            transition: all 0.3s var(--ease-elegant);
        }

        .viewfinder-corner.top-right {
            top: -1px;
            right: -1px;
            border-width: 3px 3px 0 0;
            border-radius: 0 12px 0 0;
        }

        .viewfinder-corner.bottom-left {
            bottom: -1px;
            left: -1px;
            border-width: 0 0 3px 3px;
            border-radius: 0 0 0 12px;
        }

        .viewfinder.scanning {
            border-color: var(--color-gold);
            box-shadow: 0 0 60px rgba(201, 162, 39, 0.3);
        }

        .viewfinder.scanning::before,
        .viewfinder.scanning::after,
        .viewfinder.scanning .viewfinder-corner {
            width: 40px;
            height: 40px;
        }

        /* Scan line animation */
        .scan-line {
            position: absolute;
            top: 0;
            left: 8%;
            right: 8%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-gold), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 0 20px var(--color-gold);
        }

        .scanning .scan-line {
            opacity: 1;
            animation: scanMove 1.8s ease-in-out infinite;
        }

        @keyframes scanMove {
            0%, 100% { top: 8%; }
            50% { top: 92%; }
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(to bottom, rgba(26,22,18,0.95) 0%, rgba(26,22,18,0.7) 60%, transparent 100%);
            z-index: 10;
        }

        .logo {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: var(--color-parchment);
        }

        .logo span {
            color: var(--color-gold);
            font-style: italic;
        }

        /* Capture Controls */
        .capture-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 20px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(to top, rgba(26,22,18,0.98) 0%, rgba(26,22,18,0.8) 60%, transparent 100%);
            z-index: 10;
        }

        .capture-btn {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: var(--color-parchment);
            border: 4px solid var(--color-gold);
            cursor: pointer;
            position: relative;
            transition: all 0.3s var(--ease-elegant);
            box-shadow: 0 4px 30px rgba(0,0,0,0.5), 0 0 0 0 rgba(201, 162, 39, 0);
        }

        .capture-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 40px rgba(0,0,0,0.5), 0 0 30px rgba(201, 162, 39, 0.4);
        }

        .capture-btn:active {
            transform: scale(0.92);
        }

        .capture-btn::before {
            content: '';
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            border: 2px solid var(--color-sepia);
            transition: all 0.3s;
        }

        .capture-btn::after {
            content: '';
            position: absolute;
            inset: 12px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(201, 162, 39, 0.3), transparent);
        }

        .capture-btn.analyzing {
            animation: pulse 1.2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 4px 30px rgba(0,0,0,0.5), 0 0 0 0 rgba(201, 162, 39, 0.5);
            }
            50% { 
                box-shadow: 0 4px 30px rgba(0,0,0,0.5), 0 0 50px rgba(201, 162, 39, 0.8);
            }
        }

        .capture-hint {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 14px;
            font-size: 0.75rem;
            color: rgba(247, 243, 235, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            white-space: nowrap;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* Gallery Button */
        .gallery-btn {
            position: absolute;
            left: 24px;
            bottom: 44px;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(247, 243, 235, 0.1);
            border: 1px solid rgba(247, 243, 235, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .gallery-btn:hover {
            background: rgba(247, 243, 235, 0.2);
            border-color: var(--color-gold);
        }

        .gallery-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--color-parchment);
        }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            right: 24px;
            bottom: 44px;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(247, 243, 235, 0.1);
            border: 1px solid rgba(247, 243, 235, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(247, 243, 235, 0.2);
            border-color: var(--color-gold);
        }

        .settings-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--color-parchment);
        }

        /* Story Panel - Slides up over live feed */
        .story-panel {
            position: fixed;
            inset: 0;
            background: var(--color-ink);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.6s var(--ease-elegant);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .story-panel.active {
            transform: translateY(0);
        }

        .story-image-container {
            position: relative;
            height: 35vh;
            min-height: 250px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .story-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .story-image-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                transparent 40%, 
                var(--color-ink) 100%);
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(26, 22, 18, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(247, 243, 235, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        .close-btn:hover {
            background: rgba(26, 22, 18, 0.95);
            border-color: var(--color-gold);
        }

        .close-btn svg {
            width: 20px;
            height: 20px;
            stroke: var(--color-parchment);
        }

        .story-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 40px;
            -webkit-overflow-scrolling: touch;
        }

        .story-era {
            display: inline-block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--color-gold);
            background: rgba(201, 162, 39, 0.1);
            padding: 6px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .story-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 400;
            line-height: 1.2;
            margin-bottom: 8px;
            color: var(--color-parchment);
        }

        .story-subtitle {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--color-sepia);
            margin-bottom: 24px;
        }

        .story-section {
            margin-bottom: 28px;
        }

        .story-section-title {
            font-family: var(--font-display);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--color-gold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .story-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, rgba(201, 162, 39, 0.3), transparent);
        }

        .story-text {
            font-size: 0.95rem;
            color: rgba(247, 243, 235, 0.85);
            line-height: 1.75;
        }

        .story-characteristics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .characteristic-tag {
            font-size: 0.8rem;
            padding: 8px 14px;
            background: rgba(107, 124, 94, 0.15);
            border: 1px solid rgba(107, 124, 94, 0.3);
            border-radius: 20px;
            color: var(--color-sage);
        }

        .story-fun-fact {
            background: rgba(166, 93, 63, 0.1);
            border-left: 3px solid var(--color-rust);
            padding: 16px 20px;
            border-radius: 0 8px 8px 0;
        }

        .story-fun-fact .story-text {
            color: rgba(247, 243, 235, 0.9);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            inset: 0;
            background: rgba(26, 22, 18, 0.98);
            backdrop-filter: blur(20px);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.5s var(--ease-elegant);
            display: flex;
            flex-direction: column;
        }

        .settings-panel.active {
            transform: translateX(0);
        }

        .settings-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(247, 243, 235, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .setting-group {
            margin-bottom: 32px;
        }

        .setting-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--color-sepia);
            margin-bottom: 12px;
        }

        .setting-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(247, 243, 235, 0.05);
            border: 1px solid rgba(247, 243, 235, 0.15);
            border-radius: 8px;
            color: var(--color-parchment);
            font-family: var(--font-body);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--color-gold);
            background: rgba(247, 243, 235, 0.08);
        }

        .setting-input::placeholder {
            color: rgba(247, 243, 235, 0.3);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-rust);
        }

        .status-dot.connected {
            background: var(--color-sage);
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            background: var(--color-gold);
            color: var(--color-ink);
            border: none;
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #d4ab2f;
        }

        /* Live Analysis Status - shows on camera view */
        .analysis-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .analysis-status.active {
            opacity: 1;
        }

        .analysis-spinner {
            width: 56px;
            height: 56px;
            border: 2px solid rgba(201, 162, 39, 0.2);
            border-top-color: var(--color-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .analysis-text {
            font-family: var(--font-display);
            font-size: 1rem;
            font-style: italic;
            color: var(--color-parchment);
            text-shadow: 0 2px 20px rgba(0,0,0,0.8);
        }

        /* History Panel */
        .history-panel {
            position: fixed;
            inset: 0;
            background: var(--color-ink);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.5s var(--ease-elegant);
            display: flex;
            flex-direction: column;
        }

        .history-panel.active {
            transform: translateX(0);
        }

        .history-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(247, 243, 235, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-empty {
            text-align: center;
            padding: 60px 24px;
            color: var(--color-sepia);
        }

        .history-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .history-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: rgba(247, 243, 235, 0.03);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: rgba(247, 243, 235, 0.06);
        }

        .history-item-image {
            width: 72px;
            height: 72px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-era {
            font-size: 0.75rem;
            color: var(--color-gold);
            margin-bottom: 4px;
        }

        .history-item-date {
            font-size: 0.7rem;
            color: var(--color-sepia);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--color-parchment);
            color: var(--color-ink);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.4s var(--ease-elegant);
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Hidden canvas for capture */
        #canvas {
            display: none;
        }

        /* Permission prompt */
        .permission-prompt {
            position: fixed;
            inset: 0;
            background: var(--color-ink);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .permission-prompt.hidden {
            display: none;
        }

        .permission-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            stroke: var(--color-gold);
        }

        .permission-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            margin-bottom: 12px;
        }

        .permission-text {
            color: var(--color-sepia);
            margin-bottom: 32px;
            max-width: 300px;
            line-height: 1.6;
        }

        .permission-btn {
            padding: 16px 40px;
            background: var(--color-gold);
            color: var(--color-ink);
            border: none;
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .permission-btn:hover {
            background: #d4ab2f;
            transform: scale(1.02);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(247, 243, 235, 0.2);
            border-radius: 3px;
        }

        /* Safe area handling */
        @supports (padding-top: env(safe-area-inset-top)) {
            .header {
                padding-top: calc(16px + env(safe-area-inset-top));
            }
            .live-indicator {
                top: calc(70px + env(safe-area-inset-top));
            }
            .capture-area {
                padding-bottom: calc(40px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- LIVE Camera Feed - Always visible -->
        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <div class="camera-overlay"></div>
            <div class="viewfinder" id="viewfinder">
                <div class="viewfinder-corner top-right"></div>
                <div class="viewfinder-corner bottom-left"></div>
                <div class="scan-line"></div>
            </div>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="logo">Object<span>Story</span></div>
        </header>

        <!-- Live Indicator -->
        <div class="live-indicator" id="liveIndicator">
            <div class="live-dot"></div>
            <span>Live</span>
        </div>

        <!-- Analysis Status (shows during analysis) -->
        <div class="analysis-status" id="analysisStatus">
            <div class="analysis-spinner"></div>
            <div class="analysis-text" id="analysisText">Analyzing...</div>
        </div>

        <!-- Capture Controls -->
        <div class="capture-area">
            <button class="gallery-btn" id="galleryBtn" aria-label="View history">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
            </button>
            
            <button class="capture-btn" id="captureBtn" aria-label="Analyze what you see">
                <span class="capture-hint">Tap to discover</span>
            </button>
            
            <button class="settings-btn" id="settingsBtn" aria-label="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/>
                </svg>
            </button>
        </div>

        <canvas id="canvas"></canvas>
    </div>

    <!-- Permission Prompt -->
    <div class="permission-prompt" id="permissionPrompt">
        <svg class="permission-icon" viewBox="0 0 24 24" fill="none" stroke-width="1.5">
            <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2v11z"/>
            <circle cx="12" cy="13" r="4"/>
        </svg>
        <h2 class="permission-title">Enable Live Camera</h2>
        <p class="permission-text">Point your camera at any object or building â€” tap anytime to discover its hidden story</p>
        <button class="permission-btn" id="enableCameraBtn">Enable Camera</button>
    </div>

    <!-- Story Panel -->
    <div class="story-panel" id="storyPanel">
        <div class="story-image-container">
            <img class="story-image" id="storyImage" alt="Captured object">
            <div class="story-image-overlay"></div>
            <button class="close-btn" id="closeStoryBtn" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="story-content" id="storyContent">
            <!-- Story content populated dynamically -->
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">Settings</h2>
            <button class="close-btn" id="closeSettingsBtn" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <label class="setting-label">OpenAI API Key</label>
                <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-...">
                <div class="api-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Not configured</span>
                </div>
            </div>
            <button class="save-btn" id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h2 class="history-title">Discoveries</h2>
            <button class="close-btn" id="closeHistoryBtn" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="history-content" id="historyContent">
            <!-- History items populated dynamically -->
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // App State
        const state = {
            apiKey: localStorage.getItem('objectstory_apikey') || '',
            history: JSON.parse(localStorage.getItem('objectstory_history') || '[]'),
            stream: null,
            isAnalyzing: false
        };

        // DOM Elements
        const elements = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            viewfinder: document.getElementById('viewfinder'),
            captureBtn: document.getElementById('captureBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            galleryBtn: document.getElementById('galleryBtn'),
            permissionPrompt: document.getElementById('permissionPrompt'),
            enableCameraBtn: document.getElementById('enableCameraBtn'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            storyPanel: document.getElementById('storyPanel'),
            storyImage: document.getElementById('storyImage'),
            storyContent: document.getElementById('storyContent'),
            closeStoryBtn: document.getElementById('closeStoryBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            historyPanel: document.getElementById('historyPanel'),
            historyContent: document.getElementById('historyContent'),
            closeHistoryBtn: document.getElementById('closeHistoryBtn'),
            toast: document.getElementById('toast')
        };

        // Loading messages rotation
        const loadingMessages = [
            "Consulting the archives...",
            "Tracing historical records...",
            "Analyzing design elements...",
            "Researching provenance...",
            "Uncovering hidden stories...",
            "Examining stylistic features...",
            "Cross-referencing eras..."
        ];

        // Initialize
        function init() {
            // Check if API key exists
            if (state.apiKey) {
                elements.apiKeyInput.value = state.apiKey;
                updateApiStatus(true);
            }

            // Check camera permission
            checkCameraPermission();

            // Event listeners
            elements.enableCameraBtn.addEventListener('click', requestCamera);
            elements.captureBtn.addEventListener('click', captureAndAnalyze);
            elements.settingsBtn.addEventListener('click', () => openPanel('settings'));
            elements.galleryBtn.addEventListener('click', () => openPanel('history'));
            elements.closeSettingsBtn.addEventListener('click', () => closePanel('settings'));
            elements.closeHistoryBtn.addEventListener('click', () => closePanel('history'));
            elements.closeStoryBtn.addEventListener('click', () => closePanel('story'));
            elements.saveSettingsBtn.addEventListener('click', saveSettings);

            // Render history
            renderHistory();
        }

        async function checkCameraPermission() {
            try {
                const permissions = await navigator.permissions.query({ name: 'camera' });
                if (permissions.state === 'granted') {
                    elements.permissionPrompt.classList.add('hidden');
                    startCamera();
                }
            } catch (e) {
                // Permissions API not supported, try starting camera directly
                startCamera();
            }
        }

        async function requestCamera() {
            try {
                await startCamera();
                elements.permissionPrompt.classList.add('hidden');
            } catch (error) {
                showToast('Camera access denied');
            }
        }

        async function startCamera() {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                elements.video.srcObject = state.stream;
                elements.permissionPrompt.classList.add('hidden');
            } catch (error) {
                console.error('Camera error:', error);
                throw error;
            }
        }

        function captureImage() {
            const video = elements.video;
            const canvas = elements.canvas;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            return canvas.toDataURL('image/jpeg', 0.85);
        }

        async function captureAndAnalyze() {
            if (state.isAnalyzing) return;

            if (!state.apiKey) {
                showToast('Please configure your API key first');
                openPanel('settings');
                return;
            }

            state.isAnalyzing = true;
            elements.viewfinder.classList.add('scanning');
            elements.captureBtn.classList.add('analyzing');

            // Capture image
            const imageData = captureImage();
            elements.storyImage.src = imageData;

            // Show loading
            showLoading();

            try {
                const story = await analyzeImage(imageData);
                
                // Save to history
                const historyItem = {
                    id: Date.now(),
                    image: imageData,
                    story: story,
                    timestamp: new Date().toISOString()
                };
                
                state.history.unshift(historyItem);
                if (state.history.length > 50) state.history.pop();
                localStorage.setItem('objectstory_history', JSON.stringify(state.history));
                
                // Display story
                renderStory(story);
                openPanel('story');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showToast(error.message || 'Analysis failed. Please try again.');
            } finally {
                hideLoading();
                state.isAnalyzing = false;
                elements.viewfinder.classList.remove('scanning');
                elements.captureBtn.classList.remove('analyzing');
            }
        }

        async function analyzeImage(imageData) {
            const base64Image = imageData.split(',')[1];
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {
                            role: 'system',
                            content: `You are an expert curator, historian, and art critic with encyclopedic knowledge of objects, architecture, design, and material culture across all eras and civilizations. 

When shown an image, identify the object or building and provide a rich, engaging story about it. Your response must be a valid JSON object with this structure:

{
  "title": "Name or type of the object/building",
  "subtitle": "A poetic one-line description",
  "era": "Time period or era (e.g., 'Victorian Era, 1837-1901', 'Mid-Century Modern, 1950s')",
  "style": "Architectural or design style (e.g., 'Art Deco', 'Bauhaus', 'Baroque')",
  "origin": "Geographic or cultural origin",
  "history": "2-3 paragraphs about the history, context, and significance. Make it narrative and engaging, like a museum curator telling a story.",
  "characteristics": ["Array of 4-6 distinctive features or design elements"],
  "funFact": "A surprising or little-known fact that makes this memorable",
  "materials": "Primary materials used (if identifiable)",
  "notableExamples": "Famous examples or related works (if applicable)"
}

If you cannot clearly identify the object, make educated inferences based on visual clues and be transparent about uncertainty. Always provide interesting historical and cultural context.`
                        },
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: 'Analyze this image and tell me the story behind what you see. Identify the object or building, its style, era, history, and interesting characteristics.'
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: `data:image/jpeg;base64,${base64Image}`,
                                        detail: 'high'
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            // Parse JSON from response
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Invalid response format');
            }
            
            return JSON.parse(jsonMatch[0]);
        }

        function renderStory(story) {
            const html = `
                <span class="story-era">${story.era || 'Unknown Era'}</span>
                <h1 class="story-title">${story.title}</h1>
                <p class="story-subtitle">${story.subtitle}</p>
                
                ${story.style ? `
                <div class="story-section">
                    <h3 class="story-section-title">Style & Origin</h3>
                    <p class="story-text"><strong>${story.style}</strong>${story.origin ? ` â€¢ ${story.origin}` : ''}</p>
                </div>
                ` : ''}
                
                <div class="story-section">
                    <h3 class="story-section-title">The Story</h3>
                    <p class="story-text">${story.history}</p>
                </div>
                
                ${story.characteristics?.length ? `
                <div class="story-section">
                    <h3 class="story-section-title">Key Characteristics</h3>
                    <div class="story-characteristics">
                        ${story.characteristics.map(c => `<span class="characteristic-tag">${c}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${story.materials ? `
                <div class="story-section">
                    <h3 class="story-section-title">Materials</h3>
                    <p class="story-text">${story.materials}</p>
                </div>
                ` : ''}
                
                ${story.funFact ? `
                <div class="story-section">
                    <h3 class="story-section-title">Did You Know?</h3>
                    <div class="story-fun-fact">
                        <p class="story-text">${story.funFact}</p>
                    </div>
                </div>
                ` : ''}
                
                ${story.notableExamples ? `
                <div class="story-section">
                    <h3 class="story-section-title">Notable Examples</h3>
                    <p class="story-text">${story.notableExamples}</p>
                </div>
                ` : ''}
            `;
            
            elements.storyContent.innerHTML = html;
        }

        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyContent.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">ðŸ“œ</div>
                        <p>No discoveries yet.<br>Point your camera at something interesting!</p>
                    </div>
                `;
                return;
            }

            const html = state.history.map(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                
                return `
                    <div class="history-item" data-id="${item.id}">
                        <img class="history-item-image" src="${item.image}" alt="${item.story.title}">
                        <div class="history-item-info">
                            <h4 class="history-item-title">${item.story.title}</h4>
                            <div class="history-item-era">${item.story.era || 'Unknown Era'}</div>
                            <div class="history-item-date">${dateStr}</div>
                        </div>
                    </div>
                `;
            }).join('');

            elements.historyContent.innerHTML = html;

            // Add click handlers
            elements.historyContent.querySelectorAll('.history-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = parseInt(el.dataset.id);
                    const item = state.history.find(h => h.id === id);
                    if (item) {
                        elements.storyImage.src = item.image;
                        renderStory(item.story);
                        closePanel('history');
                        setTimeout(() => openPanel('story'), 300);
                    }
                });
            });
        }

        function openPanel(panel) {
            if (panel === 'settings') {
                elements.settingsPanel.classList.add('active');
            } else if (panel === 'history') {
                renderHistory();
                elements.historyPanel.classList.add('active');
            } else if (panel === 'story') {
                elements.storyPanel.classList.add('active');
            }
        }

        function closePanel(panel) {
            if (panel === 'settings') {
                elements.settingsPanel.classList.remove('active');
            } else if (panel === 'history') {
                elements.historyPanel.classList.remove('active');
            } else if (panel === 'story') {
                elements.storyPanel.classList.remove('active');
            }
        }

        function saveSettings() {
            const apiKey = elements.apiKeyInput.value.trim();
            
            if (apiKey && !apiKey.startsWith('sk-')) {
                showToast('Invalid API key format');
                return;
            }

            state.apiKey = apiKey;
            localStorage.setItem('objectstory_apikey', apiKey);
            
            updateApiStatus(!!apiKey);
            showToast(apiKey ? 'Settings saved!' : 'API key removed');
            
            setTimeout(() => closePanel('settings'), 500);
        }

        function updateApiStatus(connected) {
            elements.statusDot.classList.toggle('connected', connected);
            elements.statusText.textContent = connected ? 'API key configured' : 'Not configured';
        }

        function showAnalysisStatus() {
            elements.analysisStatus.classList.add('active');
            let msgIndex = 0;
            
            state.analysisInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % analysisMessages.length;
                elements.analysisText.textContent = analysisMessages[msgIndex];
            }, 1500);
        }

        function hideAnalysisStatus() {
            elements.analysisStatus.classList.remove('active');
            if (state.analysisInterval) {
                clearInterval(state.analysisInterval);
            }
        }

        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Initialize app
        init();

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
                ` : ''}
                
                ${story.materials ? `
                <div class="story-section">
                    <h3 class="story-section-title">Materials</h3>
                    <p class="story-text">${story.materials}</p>
                </div>
                ` : ''}
                
                ${story.funFact ? `
                <div class="story-section">
                    <h3 class="story-section-title">Did You Know?</h3>
                    <div class="story-fun-fact">
                        <p class="story-text">${story.funFact}</p>
                    </div>
                </div>
                ` : ''}
                
                ${story.notableExamples ? `
                <div class="story-section">
                    <h3 class="story-section-title">Notable Examples</h3>
                    <p class="story-text">${story.notableExamples}</p>
                </div>
                ` : ''}
            `;
            
            elements.storyContent.innerHTML = html;
        }

        function renderHistory() {
            if (state.history.length === 0) {
                elements.historyContent.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">ðŸ“œ</div>
                        <p>No discoveries yet.<br>Point your camera at something interesting!</p>
                    </div>
                `;
                return;
            }

            const html = state.history.map(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                
                return `
                    <div class="history-item" data-id="${item.id}">
                        <img class="history-item-image" src="${item.image}" alt="${item.story.title}">
                        <div class="history-item-info">
                            <h4 class="history-item-title">${item.story.title}</h4>
                            <div class="history-item-era">${item.story.era || 'Unknown Era'}</div>
                            <div class="history-item-date">${dateStr}</div>
                        </div>
                    </div>
                `;
            }).join('');

            elements.historyContent.innerHTML = html;

            // Add click handlers
            elements.historyContent.querySelectorAll('.history-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = parseInt(el.dataset.id);
                    const item = state.history.find(h => h.id === id);
                    if (item) {
                        elements.storyImage.src = item.image;
                        renderStory(item.story);
                        closePanel('history');
                        setTimeout(() => openPanel('story'), 300);
                    }
                });
            });
        }

        function openPanel(panel) {
            if (panel === 'settings') {
                elements.settingsPanel.classList.add('active');
            } else if (panel === 'history') {
                renderHistory();
                elements.historyPanel.classList.add('active');
            } else if (panel === 'story') {
                elements.storyPanel.classList.add('active');
            }
        }

        function closePanel(panel) {
            if (panel === 'settings') {
                elements.settingsPanel.classList.remove('active');
            } else if (panel === 'history') {
                elements.historyPanel.classList.remove('active');
            } else if (panel === 'story') {
                elements.storyPanel.classList.remove('active');
            }
        }

        function saveSettings() {
            const apiKey = elements.apiKeyInput.value.trim();
            
            if (apiKey && !apiKey.startsWith('sk-')) {
                showToast('Invalid API key format');
                return;
            }

            state.apiKey = apiKey;
            localStorage.setItem('objectstory_apikey', apiKey);
            
            updateApiStatus(!!apiKey);
            showToast(apiKey ? 'Settings saved!' : 'API key removed');
            
            setTimeout(() => closePanel('settings'), 500);
        }

        function updateApiStatus(connected) {
            elements.statusDot.classList.toggle('connected', connected);
            elements.statusText.textContent = connected ? 'API key configured' : 'Not configured';
        }

        function showLoading() {
            elements.loadingOverlay.classList.add('active');
            let msgIndex = 0;
            
            state.loadingInterval = setInterval(() => {
                msgIndex = (msgIndex + 1) % loadingMessages.length;
                elements.loadingText.textContent = loadingMessages[msgIndex];
            }, 2000);
        }

        function hideLoading() {
            elements.loadingOverlay.classList.remove('active');
            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
            }
        }

        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // Initialize app
        init();

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
